<!doctype html>

<html lang="zh" class="h-full">

<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-2HTT4P5TRX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-2HTT4P5TRX');
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  
    
  

  
    
      <title>ç”¨Rustå†™ä¸€ä¸ªæ”¯æŒUEFIçš„æ“ä½œç³»ç»Ÿ (1) - Have a bite</title>
    
  

  
  <link rel="alternate" type="application/atom+xml" title="RSS" href="https://cnwzhjs.github.io/atom.xml">
  

  
  <script type="text/javascript" src="/js/menu.js"></script>
  

  
  <link href="/css/site.css" rel="stylesheet">
  

  
  
</head>

<body class="h-full">
  <div class="min-h-full">
    
    <nav class="border-b border-gray-200 bg-white">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="flex h-16 justify-between">
          <div class="flex">
            <div class="flex flex-shrink-0 items-center">
              <span class="border-transparent text-blue-500 inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium">Have a bite</span>
            </div>
            <div class="hidden sm:-my-px sm:ml-6 sm:flex sm:space-x-8">
              
                
              
                
                  
                    
                      <a href="&#x2F;zh&#x2F;" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium">
                        ä¸»é¡µ
                      </a>
                    
                  
                    
                      <a href="&#x2F;zh&#x2F;categories&#x2F;" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium">
                        åˆ†ç±»
                      </a>
                    
                  
                    
                      <a href="&#x2F;zh&#x2F;tags&#x2F;" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium">
                        æ ‡ç­¾
                      </a>
                    
                  
                    
                      <a href="&#x2F;zh&#x2F;about&#x2F;" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium">
                        å…³äº
                      </a>
                    
                  
                
              
            </div>
          </div>
          <div class="hidden sm:ml-6 sm:flex sm:items-center">
            
              <a href="&#x2F;rust-based-os-botting-with-uefi-1&#x2F;" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium">ğŸ‡¬ğŸ‡§ EN</a>
            
          </div>
          <div class="-mr-2 flex items-center sm:hidden">
            <!-- Mobile menu button -->
            <button id="menu-btn" type="button" class="relative inline-flex items-center justify-center rounded-md bg-white p-2 text-gray-400 hover:bg-gray-100 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" aria-controls="mobile-menu" aria-expanded="false">
              <span class="absolute -inset-0.5"></span>
              <span class="sr-only">Open main menu</span>
              <!-- Menu open: "hidden", Menu closed: "block" -->
              <svg id="menu-img" class="block h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
              </svg>
              <!-- Menu open: "block", Menu closed: "hidden" -->
              <svg id="close-img" class="hidden h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>
      </div>
  
      <!-- Mobile menu, show/hide based on menu state. -->
      <div class="sm:hidden hidden" id="mobile-menu">
        <div class="space-y-1 pb-3 pt-2">
          
            
          
            
              
                
                  <a href="&#x2F;zh&#x2F;" class="border-transparent text-gray-600 hover:border-gray-300 hover:bg-gray-50 hover:text-gray-800 block border-l-4 py-2 pl-3 pr-4 text-base font-medium">
                    ä¸»é¡µ
                  </a>
                
              
                
                  <a href="&#x2F;zh&#x2F;categories&#x2F;" class="border-transparent text-gray-600 hover:border-gray-300 hover:bg-gray-50 hover:text-gray-800 block border-l-4 py-2 pl-3 pr-4 text-base font-medium">
                    åˆ†ç±»
                  </a>
                
              
                
                  <a href="&#x2F;zh&#x2F;tags&#x2F;" class="border-transparent text-gray-600 hover:border-gray-300 hover:bg-gray-50 hover:text-gray-800 block border-l-4 py-2 pl-3 pr-4 text-base font-medium">
                    æ ‡ç­¾
                  </a>
                
              
                
                  <a href="&#x2F;zh&#x2F;about&#x2F;" class="border-transparent text-gray-600 hover:border-gray-300 hover:bg-gray-50 hover:text-gray-800 block border-l-4 py-2 pl-3 pr-4 text-base font-medium">
                    å…³äº
                  </a>
                
              
            
          
        </div>
        <div class="border-t border-gray-200 pb-3 pt-4">
          <div class="space-y-1">
            
              <a href="&#x2F;rust-based-os-botting-with-uefi-1&#x2F;" class="border-transparent text-gray-600 hover:border-gray-300 hover:bg-gray-50 hover:text-gray-800 block border-l-4 py-2 pl-3 pr-4 text-base font-medium">ğŸ‡¬ğŸ‡§ EN</a>
            
          </div>
        </div>
      </div>
    </nav>
    

    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      


<div class="post-toc hidden" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content always-active">
        <nav id="TableOfContents">
            <ul>
                
                <li>
                    <a href="https://cnwzhjs.github.io/zh/rust-based-os-botting-with-uefi-1/#gai-yong-uefixie-cao-zuo-xi-tong-jiao-cheng-liao" class="toc-link">è¯¥ç”¨UEFIå†™æ“ä½œç³»ç»Ÿæ•™ç¨‹äº†</a>
                    
                </li>
                
                <li>
                    <a href="https://cnwzhjs.github.io/zh/rust-based-os-botting-with-uefi-1/#pei-zhi-ce-shi-huan-jing" class="toc-link">é…ç½®æµ‹è¯•ç¯å¢ƒ</a>
                    
                </li>
                
                <li>
                    <a href="https://cnwzhjs.github.io/zh/rust-based-os-botting-with-uefi-1/#zhun-bei-gou-jian-huan-jing" class="toc-link">å‡†å¤‡æ„å»ºç¯å¢ƒ</a>
                    
                </li>
                
                <li>
                    <a href="https://cnwzhjs.github.io/zh/rust-based-os-botting-with-uefi-1/#zhun-bei-yi-ge-zui-jian-dan-de-nei-he" class="toc-link">å‡†å¤‡ä¸€ä¸ªæœ€ç®€å•çš„å†…æ ¸</a>
                    
                </li>
                
                <li>
                    <a href="https://cnwzhjs.github.io/zh/rust-based-os-botting-with-uefi-1/#gou-jian-he-yun-xing-ni-de-di-yi-ge-uefinei-he" class="toc-link">æ„å»ºå’Œè¿è¡Œä½ çš„ç¬¬ä¸€ä¸ªUEFIå†…æ ¸</a>
                    
                </li>
                
                <li>
                    <a href="https://cnwzhjs.github.io/zh/rust-based-os-botting-with-uefi-1/#yan-shen-yue-du" class="toc-link">å»¶ä¼¸é˜…è¯»</a>
                    
                </li>
                
                <li>
                    <a href="https://cnwzhjs.github.io/zh/rust-based-os-botting-with-uefi-1/#xiu-gai-li-shi" class="toc-link">ä¿®æ”¹å†å²</a>
                    
                </li>
                
            </ul>
        </nav>
    </div>
</div>


<article class="prose">
    
<h2>
    <a href="https:&#x2F;&#x2F;cnwzhjs.github.io&#x2F;zh&#x2F;rust-based-os-botting-with-uefi-1&#x2F;">ç”¨Rustå†™ä¸€ä¸ªæ”¯æŒUEFIçš„æ“ä½œç³»ç»Ÿ (1)</a>
</h2>
<div class="post__meta">
    <span class="post__time">2023-10-15</span>
    
</div>

    <div class="post-content">
      <blockquote>
<p>æ‰€æœ‰çš„ä»£ç éƒ½å¯ä»¥ä»æˆ‘çš„<a rel="noopener" target="_blank" href="https://github.com/cnwzhjs/blog-uefi-os">GitHub repo</a>è·å¾—</p>
</blockquote>
<h3 id="gai-yong-uefixie-cao-zuo-xi-tong-jiao-cheng-liao">è¯¥ç”¨UEFIå†™æ“ä½œç³»ç»Ÿæ•™ç¨‹äº†</h3>
<p>æœ‰å¾ˆå¤šæ“ä½œç³»ç»Ÿæ•™ç¨‹å’Œ YouTube è§†é¢‘ã€‚ç„¶è€Œï¼Œå®ƒä»¬ä¸­çš„å¤§å¤šæ•°éƒ½æ˜¯ä¸º BIOS æ¨¡å¼å¯åŠ¨ç¼–å†™çš„ã€‚</p>
<p>ç„¶è€Œï¼Œç°åœ¨å·²ç»2023å¹´äº†ï¼Œç¦»Intelå¼€æºUEFIçš„å®ç°å·²ç»æ•´æ•´19å¹´äº†ã€‚åŒæ—¶ï¼ŒIntelæ­£åœ¨æŠ›å¼ƒä¼ ç»Ÿçš„<code>x86_64</code>æ¶æ„ï¼Œè½¬å‘åªæ”¯æŒ64ä½çš„<code>x86_64s</code>. å½“ç„¶ï¼Œå®ƒåªæ”¯æŒUEFIï¼ˆUEFI CSMå°†è¢«åˆ é™¤ï¼‰ã€‚</p>
<p>UEFIæ˜¯ä¸€ä¸ªæ›´å®‰å…¨ã€æ›´å¼ºå¤§çš„å¼•å¯¼ç³»ç»Ÿã€‚å‡ ä¹æ‰€æœ‰ç°ä»£æ“ä½œç³»ç»Ÿéƒ½æ˜¯é€šè¿‡UEFIå¼•å¯¼çš„ã€‚ä¼¼ä¹æ²¡æœ‰ç†ç”±ç»§ç»­ä¸ºBIOSç¼–å†™æ“ä½œç³»ç»Ÿæ•™ç¨‹ã€‚æˆ‘ä»¬ä¸å†éœ€è¦å…³å¿ƒå¦‚ä½•åˆ‡æ¢åˆ°é•¿æ¨¡å¼ï¼Œæˆ–è€…å¯ç”¨åˆ†é¡µä¹‹ç±»çš„çƒ¦äººç»†èŠ‚ã€‚</p>
<p>æˆ‘åœ¨Googleä¸Šæœç´¢åå‘ç°ï¼Œå…³äºåœ¨UEFIä¸­ç¼–å†™æ“ä½œç³»ç»Ÿçš„ä¿¡æ¯éå¸¸æœ‰é™ã€‚è¿™äº›ä¿¡æ¯åˆ†æ•£åœ¨ä¸åŒçš„åœ°æ–¹ï¼Œå¾ˆéš¾æ‰¾åˆ°å®Œæ•´çš„æ•™ç¨‹ã€‚å› æ­¤ï¼Œæˆ‘å†³å®šå†™ä¸€ç³»åˆ—å…³äºåœ¨UEFIä¸­ç¼–å†™æ“ä½œç³»ç»Ÿçš„æ•™ç¨‹ã€‚</p>
<span id="continue-reading"></span><h3 id="pei-zhi-ce-shi-huan-jing">é…ç½®æµ‹è¯•ç¯å¢ƒ</h3>
<p>å¤§å¤šæ•°æ“ä½œç³»ç»Ÿæ•™ç¨‹éƒ½ä½¿ç”¨QEMUä½œä¸ºæµ‹è¯•ç¯å¢ƒï¼Œå› ä¸ºå®ƒæœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š</p>
<ol>
<li>åªéœ€è¦æ™®é€šç”¨æˆ·æƒé™å°±å¯ä»¥æ‰§è¡Œï¼ˆQEMUå¯ä»¥åœ¨æ¨¡æ‹Ÿå™¨æ¨¡å¼ä¸‹è¿è¡Œï¼Œè¿™æ„å‘³ç€å®ƒä¸éœ€è¦è®¿é—®ä»»ä½•ç¡¬ä»¶è™šæ‹ŸåŒ–åŸºç¡€æ¶æ„ï¼Œä¾‹å¦‚KVMï¼‰ã€‚</li>
<li>å®ƒéå¸¸çµæ´»ï¼Œå¯ä»¥é…ç½®ä¸åŒçš„ç¡¬ä»¶ã€‚</li>
<li>å®ƒæ”¯æŒå„ç§å®¢æˆ·ç«¯CPUæ¶æ„ã€‚æ­¤å¤–ï¼Œæ¨¡æ‹Ÿå™¨å¯ä»¥åœ¨ä¸å®¢æˆ·ç«¯CPUä¸åŒçš„ä¸»æœºCPUæ¶æ„ä¸Šè¿è¡Œã€‚</li>
<li>å®ƒæ”¯æŒæ¨¡æ‹ŸBIOSæˆ–UEFIä½œä¸ºå›ºä»¶æ¥å£ã€‚</li>
<li>å®ƒæ”¯æŒè°ƒè¯•å™¨ï¼Œå¯ä»¥è½»æ¾è°ƒè¯•æ“ä½œç³»ç»Ÿå†…æ ¸ï¼ˆé€šå¸¸åœ¨è£¸æœºä¸Šä½¿ç”¨æ—¥å¿—è®°å½•æ¥è°ƒè¯•å†…æ ¸ï¼‰ã€‚</li>
</ol>
<p>å› æ­¤ï¼Œåœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿä½¿ç”¨QEMUä½œä¸ºæµ‹è¯•ç¯å¢ƒã€‚å¥½å§ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯MacBook Proï¼Œæ‰€ä»¥æ•™ç¨‹çš„å‘½ä»¤è¡Œæ˜¯é’ˆå¯¹macOSçš„ï¼Œä½†æ˜¯å¾ˆå®¹æ˜“è½¬æ¢ä¸ºLinuxç‰ˆæœ¬ã€‚</p>
<ol>
<li>å®‰è£…QEMU</li>
</ol>
<p>æˆ‘ä»¬é€šå¸¸ä½¿ç”¨<a rel="noopener" target="_blank" href="https://brew.sh">homebrew</a>æ¥å®‰è£…qemuï¼š</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">brew</span><span> install qemu
</span></code></pre>
<ol start="2">
<li>ä¸ºé¡¹ç›®åˆ›å»ºå·¥ä½œç©ºé—´</li>
</ol>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">mkdir</span><span> tony-os &amp;&amp; </span><span style="color:#96b5b4;">cd</span><span> tony-os
</span><span style="color:#bf616a;">git</span><span> init .
</span><span style="color:#bf616a;">mkdir -p</span><span> src build buildenv {target,dist}/x86_64
</span></code></pre>
<ol start="3">
<li>ä¸ºQEMUå‡†å¤‡UEFIå›ºä»¶</li>
</ol>
<p>Intelçš„å¼€æºUEFIå›ºä»¶ç§°ä¸º<a rel="noopener" target="_blank" href="http://www.tianocore.org">TianoCoreé¡¹ç›®</a>ã€‚ä»£ç ä¹Ÿæ‰˜ç®¡åœ¨<a rel="noopener" target="_blank" href="https://github.com/tianocore">GitHub</a>.</p>
<p>åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œä»–ä»¬å¼€å‘äº†ä¸€ä¸ªæ”¯æŒQEMUçš„å›ºä»¶ï¼Œæä¾›äº†ä¸€ä¸ªUEFIç¯å¢ƒã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä»<a rel="noopener" target="_blank" href="https://www.kraxel.org/repos/jenkins/edk2/">ä»–ä»¬çš„æŒç»­é›†æˆæœåŠ¡å™¨ä¸Š</a>ä¸‹è½½å®ƒï¼Œæ‰¾åˆ°ä¸€ä¸ªä»¥&quot;edk2.git-ovmf.x64&quot;å¼€å¤´çš„æ–‡ä»¶ï¼Œè§£å‹å®ƒï¼Œç„¶åå°†<code>usr/share/edk2.git/ovmf-x64/OVMF-pure-efi.fd</code>å¤åˆ¶åˆ°æˆ‘ä»¬çš„å·¥ä½œç©ºé—´çš„<code>target/x86_64/bios.bin</code>ã€‚</p>
<ol start="4">
<li>å‡†å¤‡è„šæœ¬æ¥æµ‹è¯•æˆ‘ä»¬çš„UEFI</li>
</ol>
<p>åœ¨æˆ‘ä»¬çš„å·¥ä½œç©ºé—´ä¸­å†™å…¥<code>run.sh</code>è„šæœ¬ï¼š</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#65737e;">#! /bin/bash
</span><span>
</span><span style="color:#bf616a;">qemu-system-x86_64 </span><span>\
</span><span style="color:#bf616a;">    -L</span><span> target/x86_64 \
</span><span style="color:#bf616a;">    -bios</span><span> target/x86_64/bios.bin \
</span><span style="color:#bf616a;">    -hda</span><span> fat:rw:dist/x86_64
</span></code></pre>
<p>ç„¶åï¼Œä½¿å…¶å¯æ‰§è¡Œï¼š<code>chmod +x run.sh</code>ã€‚</p>
<p>å¦‚æœä½ ç›´æ¥è¿è¡Œè„šæœ¬çš„è¯ï¼Œåº”è¯¥ä¼šå¯åŠ¨å¹¶æ˜¾ç¤ºTianoCoreçš„å›¾åƒã€‚</p>
<p>æ­¤äº‹ï¼Œä½ çš„å·¥ä½œç©ºé—´åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š</p>
<pre data-lang="text" style="background-color:#2b303b;color:#c0c5ce;" class="language-text "><code class="language-text" data-lang="text"><span>build
</span><span>buildenv
</span><span>dist
</span><span>|- x86_64
</span><span>src
</span><span>target
</span><span>|- x86_64
</span><span>   |- bios.bin
</span><span>run.sh
</span></code></pre>
<h3 id="zhun-bei-gou-jian-huan-jing">å‡†å¤‡æ„å»ºç¯å¢ƒ</h3>
<p>Dockeræ˜¯ä¸€ä¸ªç”¨æ¥å›ºåŒ–ä½ çš„æ„å»ºç¯å¢ƒçš„å®Œç¾å¹³å°ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨<code>buildenv</code>æ–‡ä»¶å¤¹ä¸‹å‡†å¤‡ä¸€ä¸ª<code>Dockerfile</code>ï¼Œæ¥æ„å»ºä¸€ä¸ªæ„å»ºç¯å¢ƒçš„é•œåƒï¼š</p>
<pre data-lang="dockerfile" style="background-color:#2b303b;color:#c0c5ce;" class="language-dockerfile "><code class="language-dockerfile" data-lang="dockerfile"><span style="color:#b48ead;">FROM</span><span> rust:1.73-bullseye
</span><span>
</span><span style="color:#b48ead;">RUN </span><span>rustup target add x86_64-unknown-uefi
</span><span>
</span><span style="color:#b48ead;">VOLUME </span><span>/root/env
</span><span>
</span><span style="color:#b48ead;">WORKDIR </span><span>/root/env
</span></code></pre>
<blockquote>
<p>Rustå¯¹UEFIç›®æ ‡æœ‰ç¬¬äºŒçº§æ”¯æŒï¼Œè¿™æ„å‘³ç€å®ƒä¸æ˜¯å®˜æ–¹æ”¯æŒçš„ã€‚ä½†æ˜¯ï¼Œå®ƒå¯¹æˆ‘ä»¬æ¥è¯´è¶³å¤Ÿå¥½äº†ï¼Œå¯ä»¥å†™ä¸€ä¸ªç©å…·æ“ä½œç³»ç»Ÿã€‚</p>
<p>æ„Ÿè°¢David Rheinsberg(<a rel="noopener" target="_blank" href="https://github.com/dvdhrm">@dvdhrm</a>) å’Œ Nicholas Bishop(<a rel="noopener" target="_blank" href="https://github.com/nicholasbishop">@nicholasbishop</a>)ç»´æŠ¤äº†Rustçš„UEFIç›®æ ‡</p>
</blockquote>
<p>æ„å»ºé•œåƒ</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">docker</span><span> build</span><span style="color:#bf616a;"> --platform</span><span> linux/x86_64 buildenv</span><span style="color:#bf616a;"> -t</span><span> tonyos-buildenv
</span></code></pre>
<h3 id="zhun-bei-yi-ge-zui-jian-dan-de-nei-he">å‡†å¤‡ä¸€ä¸ªæœ€ç®€å•çš„å†…æ ¸</h3>
<p>David Rheinsbergï¼ŒUEFIç›®æ ‡çš„ç»´æŠ¤è€…ï¼Œè¿˜ç»´æŠ¤äº†ä¸€ä¸ªå«<a rel="noopener" target="_blank" href="https://github.com/r-efi/r-efi">r-efi</a>çš„crateï¼Œæä¾›äº†UEFIçš„æ¥å£ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªcrateæ¥å¿«é€Ÿå¼€å§‹ã€‚</p>
<ol>
<li>åˆ›å»ºåœ¨æ„å»ºå®¹å™¨ä¸­è¿è¡Œçš„æ„å»ºè„šæœ¬ï¼šbuildscript.sh</li>
</ol>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#65737e;">#! /bin/bash
</span><span>
</span><span style="color:#65737e;"># build the kernel
</span><span style="color:#bf616a;">cargo</span><span> build</span><span style="color:#bf616a;"> --target</span><span> x86_64-unknown-uefi || </span><span style="color:#96b5b4;">exit</span><span> 1
</span><span>
</span><span style="color:#65737e;"># copy the built kernel to the dist directory
</span><span style="color:#bf616a;">mkdir -p</span><span> dist/x86_64/EFI/BOOT || </span><span style="color:#96b5b4;">exit</span><span> 1
</span><span>
</span><span style="color:#bf616a;">cp</span><span> target/x86_64-unknown-uefi/debug/tonyos.efi \
</span><span>   dist/x86_64/EFI/BOOT/BOOTX64.EFI || </span><span style="color:#96b5b4;">exit</span><span> 1
</span></code></pre>
<ol start="2">
<li>åˆ›å»ºè°ƒç”¨å®¹å™¨çš„æ„å»ºè„šæœ¬ï¼šbuild.sh</li>
</ol>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#65737e;">#! /bin/bash
</span><span>
</span><span style="color:#bf616a;">docker</span><span> run</span><span style="color:#bf616a;"> -it </span><span>\
</span><span style="color:#bf616a;">    --platform</span><span> linux/x86_64 \
</span><span style="color:#bf616a;">    --rm </span><span>\
</span><span style="color:#bf616a;">    -v </span><span>$(</span><span style="color:#bf616a;">pwd</span><span>):/root/env \
</span><span>    tonyos-buildenv \
</span><span>    ./buildscript.sh
</span></code></pre>
<ol start="3">
<li>å‡†å¤‡å†…æ ¸å…¥å£æ–‡ä»¶<code>src/main.rs</code></li>
</ol>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#![</span><span style="color:#bf616a;">no_main</span><span>]
</span><span>#![</span><span style="color:#bf616a;">no_std</span><span>]
</span><span>
</span><span style="color:#b48ead;">use </span><span>uefi::prelude::*;
</span><span style="color:#b48ead;">use </span><span>uefi_services::*;
</span><span>
</span><span style="color:#b48ead;">const </span><span style="color:#d08770;">HELLO_STR</span><span>: &amp;</span><span style="color:#b48ead;">str </span><span>= &quot;</span><span style="color:#a3be8c;">Hello, world. Press any key to return to UEFI firmware.</span><span>&quot;;
</span><span>
</span><span>#[</span><span style="color:#bf616a;">entry</span><span>]
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">main</span><span>(</span><span style="color:#bf616a;">_handle</span><span>: Handle, </span><span style="color:#b48ead;">mut </span><span style="color:#bf616a;">system_table</span><span>: SystemTable&lt;Boot&gt;) -&gt; Status {
</span><span>    uefi_services::init(&amp;</span><span style="color:#b48ead;">mut</span><span> system_table).</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>
</span><span>    println!(&quot;</span><span style="color:#d08770;">{}</span><span>&quot;, </span><span style="color:#d08770;">HELLO_STR</span><span>);
</span><span>
</span><span>    </span><span style="color:#b48ead;">let mut</span><span> events = [ system_table.</span><span style="color:#96b5b4;">stdin</span><span>().</span><span style="color:#96b5b4;">wait_for_key_event</span><span>().</span><span style="color:#96b5b4;">unwrap</span><span>() ];
</span><span>    system_table.</span><span style="color:#96b5b4;">boot_services</span><span>().</span><span style="color:#96b5b4;">wait_for_event</span><span>(&amp;</span><span style="color:#b48ead;">mut</span><span> events).</span><span style="color:#96b5b4;">discard_errdata</span><span>().</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>
</span><span>    Status::</span><span style="color:#d08770;">SUCCESS
</span><span>}
</span></code></pre>
<ol start="4">
<li>å‡†å¤‡<code>Cargo.toml</code>æ–‡ä»¶</li>
</ol>
<pre data-lang="toml" style="background-color:#2b303b;color:#c0c5ce;" class="language-toml "><code class="language-toml" data-lang="toml"><span>[package]
</span><span style="color:#bf616a;">name </span><span>= &quot;</span><span style="color:#a3be8c;">tonyos</span><span>&quot;
</span><span style="color:#bf616a;">version </span><span>= &quot;</span><span style="color:#a3be8c;">0.1.0</span><span>&quot;
</span><span style="color:#bf616a;">authors </span><span>= [&quot;</span><span style="color:#a3be8c;">Tony Huang &lt;tony@tonyhuang.dev&gt;</span><span>&quot;]
</span><span style="color:#bf616a;">edition </span><span>= &quot;</span><span style="color:#a3be8c;">2021</span><span>&quot;
</span><span>
</span><span>[build]
</span><span style="color:#bf616a;">build-stage </span><span>= </span><span style="color:#d08770;">1
</span><span style="color:#bf616a;">target </span><span>= [&quot;</span><span style="color:#a3be8c;">x86_64-unknown-uefi</span><span>&quot;]
</span><span>
</span><span>[dependencies]
</span><span style="color:#bf616a;">uefi </span><span>= { </span><span style="color:#bf616a;">version </span><span>= &quot;</span><span style="color:#a3be8c;">0.25</span><span>&quot;, </span><span style="color:#bf616a;">features </span><span>= [&quot;</span><span style="color:#a3be8c;">alloc</span><span>&quot;] }
</span><span style="color:#bf616a;">uefi-services </span><span>= &quot;</span><span style="color:#a3be8c;">0.22</span><span>&quot;
</span><span>
</span><span style="color:#65737e;"># the profile used for `cargo build`
</span><span>[profile.dev]
</span><span style="color:#bf616a;">panic </span><span>= &quot;</span><span style="color:#a3be8c;">abort</span><span>&quot; </span><span style="color:#65737e;"># disable stack unwinding on panic
</span><span>
</span><span style="color:#65737e;"># the profile used for `cargo build --release`
</span><span>[profile.release]
</span><span style="color:#bf616a;">panic </span><span>= &quot;</span><span style="color:#a3be8c;">abort</span><span>&quot; </span><span style="color:#65737e;"># disable stack unwinding on panic
</span></code></pre>
<h3 id="gou-jian-he-yun-xing-ni-de-di-yi-ge-uefinei-he">æ„å»ºå’Œè¿è¡Œä½ çš„ç¬¬ä¸€ä¸ªUEFIå†…æ ¸</h3>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºå’Œè¿è¡Œæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªUEFIå†…æ ¸äº†ï¼š</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">./build.sh </span><span>&amp;&amp; </span><span style="color:#bf616a;">./run.sh
</span></code></pre>
<p><img src="/images/uefi-first-boot.png" alt="UEFI Hello World" /></p>
<h3 id="yan-shen-yue-du">å»¶ä¼¸é˜…è¯»</h3>
<p>ä¸‹ä¸€ç¯‡ï¼š<a href="/zh/rust-based-os-booting-with-uefi-2/">è·å–å…³é”®ç¡¬ä»¶ä¿¡æ¯</a></p>
<h3 id="xiu-gai-li-shi">ä¿®æ”¹å†å²</h3>
<ol>
<li>2023-10-24: è¿ç§»åˆ° <code>uefi</code> crate</li>
</ol>

    </div>

    
    

    <div class="post-footer">
        
            
                <div class="post-tags">
                    
                        <a href="https://cnwzhjs.github.io/tags/uefi/">#uefi</a>
                    
                        <a href="https://cnwzhjs.github.io/tags/efi/">#efi</a>
                    
                        <a href="https://cnwzhjs.github.io/tags/os/">#os</a>
                    
                        <a href="https://cnwzhjs.github.io/tags/rust/">#rust</a>
                    
                </div>
            
            
                <div class="post-nav">
                    
                        <a class="previous" href="https:&#x2F;&#x2F;cnwzhjs.github.io&#x2F;zh&#x2F;rust-based-os-booting-with-uefi-2&#x2F;">â€¹ ç”¨Rustå†™ä¸€ä¸ªæ”¯æŒUEFIçš„æ“ä½œç³»ç»Ÿ (2)</a>
                    
                    
                        <a class="next" href="https:&#x2F;&#x2F;cnwzhjs.github.io&#x2F;zh&#x2F;hello-world&#x2F;">Hello, world â€º</a>
                    
                </div>
            

        

    </div>

    
    
</article>


    </div>
  </div>
</body>

</html>
