<!doctype html>

<html lang="zh" class="h-full">

<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-2HTT4P5TRX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-2HTT4P5TRX');
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  
    
  

  
    
      <title>用Rust写一个支持UEFI的操作系统 (2) - Have a bite</title>
    
  

  
  <link rel="alternate" type="application/atom+xml" title="RSS" href="https://cnwzhjs.github.io/atom.xml">
  

  
  <script type="text/javascript" src="/js/menu.js"></script>
  

  
  <link href="/css/site.css" rel="stylesheet">
  

  
  
</head>

<body class="h-full">
  <div class="min-h-full">
    
    <nav class="border-b border-gray-200 bg-white">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="flex h-16 justify-between">
          <div class="flex">
            <div class="flex flex-shrink-0 items-center">
              <span class="border-transparent text-blue-500 inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium">Have a bite</span>
            </div>
            <div class="hidden sm:-my-px sm:ml-6 sm:flex sm:space-x-8">
              
                
              
                
                  
                    
                      <a href="&#x2F;zh&#x2F;" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium">
                        主页
                      </a>
                    
                  
                    
                      <a href="&#x2F;zh&#x2F;categories&#x2F;" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium">
                        分类
                      </a>
                    
                  
                    
                      <a href="&#x2F;zh&#x2F;tags&#x2F;" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium">
                        标签
                      </a>
                    
                  
                    
                      <a href="&#x2F;zh&#x2F;about&#x2F;" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium">
                        关于
                      </a>
                    
                  
                
              
            </div>
          </div>
          <div class="hidden sm:ml-6 sm:flex sm:items-center">
            
              <a href="&#x2F;rust-based-os-booting-with-uefi-2&#x2F;" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium">🇬🇧 EN</a>
            
          </div>
          <div class="-mr-2 flex items-center sm:hidden">
            <!-- Mobile menu button -->
            <button id="menu-btn" type="button" class="relative inline-flex items-center justify-center rounded-md bg-white p-2 text-gray-400 hover:bg-gray-100 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" aria-controls="mobile-menu" aria-expanded="false">
              <span class="absolute -inset-0.5"></span>
              <span class="sr-only">Open main menu</span>
              <!-- Menu open: "hidden", Menu closed: "block" -->
              <svg id="menu-img" class="block h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
              </svg>
              <!-- Menu open: "block", Menu closed: "hidden" -->
              <svg id="close-img" class="hidden h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>
      </div>
  
      <!-- Mobile menu, show/hide based on menu state. -->
      <div class="sm:hidden hidden" id="mobile-menu">
        <div class="space-y-1 pb-3 pt-2">
          
            
          
            
              
                
                  <a href="&#x2F;zh&#x2F;" class="border-transparent text-gray-600 hover:border-gray-300 hover:bg-gray-50 hover:text-gray-800 block border-l-4 py-2 pl-3 pr-4 text-base font-medium">
                    主页
                  </a>
                
              
                
                  <a href="&#x2F;zh&#x2F;categories&#x2F;" class="border-transparent text-gray-600 hover:border-gray-300 hover:bg-gray-50 hover:text-gray-800 block border-l-4 py-2 pl-3 pr-4 text-base font-medium">
                    分类
                  </a>
                
              
                
                  <a href="&#x2F;zh&#x2F;tags&#x2F;" class="border-transparent text-gray-600 hover:border-gray-300 hover:bg-gray-50 hover:text-gray-800 block border-l-4 py-2 pl-3 pr-4 text-base font-medium">
                    标签
                  </a>
                
              
                
                  <a href="&#x2F;zh&#x2F;about&#x2F;" class="border-transparent text-gray-600 hover:border-gray-300 hover:bg-gray-50 hover:text-gray-800 block border-l-4 py-2 pl-3 pr-4 text-base font-medium">
                    关于
                  </a>
                
              
            
          
        </div>
        <div class="border-t border-gray-200 pb-3 pt-4">
          <div class="space-y-1">
            
              <a href="&#x2F;rust-based-os-booting-with-uefi-2&#x2F;" class="border-transparent text-gray-600 hover:border-gray-300 hover:bg-gray-50 hover:text-gray-800 block border-l-4 py-2 pl-3 pr-4 text-base font-medium">🇬🇧 EN</a>
            
          </div>
        </div>
      </div>
    </nav>
    

    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      


<div class="post-toc hidden" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content always-active">
        <nav id="TableOfContents">
            <ul>
                
                <li>
                    <a href="https://cnwzhjs.github.io/zh/rust-based-os-booting-with-uefi-2/#shi-yao-shi-cao-zuo-xi-tong" class="toc-link">什么是操作系统</a>
                    
                </li>
                
                <li>
                    <a href="https://cnwzhjs.github.io/zh/rust-based-os-booting-with-uefi-2/#cpuid-zhi-ling" class="toc-link">cpuid 指令</a>
                    
                </li>
                
                <li>
                    <a href="https://cnwzhjs.github.io/zh/rust-based-os-booting-with-uefi-2/#jian-ce-nei-cun-bu-ju" class="toc-link">检测内存布局</a>
                    
                </li>
                
                <li>
                    <a href="https://cnwzhjs.github.io/zh/rust-based-os-booting-with-uefi-2/#jian-ce-tu-xing-xi-tong" class="toc-link">检测图形系统</a>
                    
                </li>
                
                <li>
                    <a href="https://cnwzhjs.github.io/zh/rust-based-os-booting-with-uefi-2/#jie-xia-lai-zuo-shi-yao" class="toc-link">接下来做什么</a>
                    
                </li>
                
                <li>
                    <a href="https://cnwzhjs.github.io/zh/rust-based-os-booting-with-uefi-2/#yan-shen-yue-du" class="toc-link">延伸阅读</a>
                    
                </li>
                
            </ul>
        </nav>
    </div>
</div>


<article class="prose">
    
<h2>
    <a href="https:&#x2F;&#x2F;cnwzhjs.github.io&#x2F;zh&#x2F;rust-based-os-booting-with-uefi-2&#x2F;">用Rust写一个支持UEFI的操作系统 (2)</a>
</h2>
<div class="post__meta">
    <span class="post__time">2023-10-24</span>
    
</div>

    <div class="post-content">
      <blockquote>
<p>所有的代码都可以从我的<a rel="noopener" target="_blank" href="https://github.com/cnwzhjs/blog-uefi-os">GitHub repo</a>获得</p>
</blockquote>
<h3 id="shi-yao-shi-cao-zuo-xi-tong">什么是操作系统</h3>
<p>在现代语境下，OS这个单词可能代表很多东西。</p>
<p>OS可以用来命名一个内核，例如Linux，Mach（macOS的内核）等。OS也可以用来命名一个内核和一组用户空间程序，例如GNU/Linux，macOS等。</p>
<p>在本系列文章中，我们主要关注OS内核的部分。那么OS的内核主要做什么呢？</p>
<p>OS内核的主要作用是提供硬件资源的虚拟化抽象，并为用户空间程序提供一组API来使用这些资源。</p>
<p>在这个定义中，OS内核应该：</p>
<ol>
<li>管理计算（CPU，GPU，应用程序特定加速器）和存储资源（内存，磁盘等），并将它们分配给用户空间程序。</li>
<li>提供一个统一的接口来操作外设（键盘，鼠标，网络等）。</li>
</ol>
<p>所以，在这篇文章中，我们会尝试通过UEFI接口检测设备的核心硬件资源：</p>
<ol>
<li>CPU</li>
<li>内存布局</li>
<li>图形</li>
</ol>
<span id="continue-reading"></span><h3 id="cpuid-zhi-ling"><code>cpuid</code> 指令</h3>
<p>对于所有的x86 CPU，都有一个特殊的指令叫做<code>cpuid</code>。它用于查询CPU的特性。在rust中，我们可以使用<code>raw-cpuid</code> crate来访问这个指令。</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">print_cpu_info</span><span>() {
</span><span>    </span><span style="color:#b48ead;">let</span><span> cpuid = CpuId::new();
</span><span>    </span><span style="color:#b48ead;">let</span><span> vendor_info = cpuid.</span><span style="color:#96b5b4;">get_vendor_info</span><span>().</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">Vendor: </span><span style="color:#d08770;">{}</span><span>&quot;, vendor_info.</span><span style="color:#96b5b4;">as_str</span><span>());
</span><span>    </span><span style="color:#b48ead;">let</span><span> brand_info = cpuid.</span><span style="color:#96b5b4;">get_processor_brand_string</span><span>().</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">Processor: </span><span style="color:#d08770;">{}</span><span>&quot;, brand_info.</span><span style="color:#96b5b4;">as_str</span><span>());
</span><span>    </span><span style="color:#b48ead;">let</span><span> feature_info = cpuid.</span><span style="color:#96b5b4;">get_feature_info</span><span>().</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>    </span><span style="color:#b48ead;">let</span><span> extended_processor_feature_info = cpuid.</span><span style="color:#96b5b4;">get_extended_processor_and_feature_identifiers</span><span>().</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>    </span><span style="color:#b48ead;">let</span><span> advanced_pm_info = cpuid.</span><span style="color:#96b5b4;">get_advanced_power_mgmt_info</span><span>().</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">Family: </span><span style="color:#d08770;">{:02X}</span><span style="color:#a3be8c;">h, Model: </span><span style="color:#d08770;">{:02X}</span><span style="color:#a3be8c;">h, Step: </span><span style="color:#d08770;">{:02X}</span><span style="color:#a3be8c;">h</span><span>&quot;, feature_info.</span><span style="color:#96b5b4;">family_id</span><span>(), feature_info.</span><span style="color:#96b5b4;">model_id</span><span>(), feature_info.</span><span style="color:#96b5b4;">stepping_id</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">Max logical processor ids: </span><span style="color:#d08770;">{}</span><span>&quot;, feature_info.</span><span style="color:#96b5b4;">max_logical_processor_ids</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">Features:</span><span>&quot;);
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">    vmx: </span><span style="color:#d08770;">{}</span><span>&quot;, feature_info.</span><span style="color:#96b5b4;">has_vmx</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">    hypervisor: </span><span style="color:#d08770;">{}</span><span>&quot;, feature_info.</span><span style="color:#96b5b4;">has_hypervisor</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">    tsc: </span><span style="color:#d08770;">{}</span><span>&quot;, feature_info.</span><span style="color:#96b5b4;">has_tsc</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">    psn: </span><span style="color:#d08770;">{}</span><span>&quot;, feature_info.</span><span style="color:#96b5b4;">has_psn</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">    sysenter &amp; sysexit: </span><span style="color:#d08770;">{}</span><span>&quot;, feature_info.</span><span style="color:#96b5b4;">has_sysenter_sysexit</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">    syscall &amp; sysret: </span><span style="color:#d08770;">{}</span><span>&quot;, extended_processor_feature_info.</span><span style="color:#96b5b4;">has_syscall_sysret</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">    svm: </span><span style="color:#d08770;">{}</span><span>&quot;, extended_processor_feature_info.</span><span style="color:#96b5b4;">has_svm</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">    de: </span><span style="color:#d08770;">{}</span><span>&quot;, extended_processor_feature_info.</span><span style="color:#96b5b4;">has_execute_disable</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">    1g pages: </span><span style="color:#d08770;">{}</span><span>&quot;, extended_processor_feature_info.</span><span style="color:#96b5b4;">has_1gib_pages</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">    rdtscp: </span><span style="color:#d08770;">{}</span><span>&quot;, extended_processor_feature_info.</span><span style="color:#96b5b4;">has_rdtscp</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">    invariant tsc: </span><span style="color:#d08770;">{}</span><span>&quot;, advanced_pm_info.</span><span style="color:#96b5b4;">has_invariant_tsc</span><span>());
</span><span>}
</span></code></pre>
<p>在上面的代码中，我们获取了CPU的基本信息。更重要的是检测CPU的特性。我们看到了很多缩写，让我们一一解释一下我们的OS所需的特性：</p>
<ol>
<li><code>tsc</code>: 时间戳计数器（我们需要检测CPU是否支持 <code>rdtsc</code> 指令)</li>
<li><code>syscall</code> &amp; <code>sysret</code>: 系统调用和系统返回指令。（如果你读过一些比较老的操作系统教程，他们会使用<code>int</code>指令来实现用户态和内核态的切换，在现代操作系统中，通常使用这两个指令来完成这个任务，它的overhead要更小一些）</li>
</ol>
<p>对于上述检测的其他特性，我们会在以后的文章中解释，在本文中不再赘述。</p>
<h3 id="jian-ce-nei-cun-bu-ju">检测内存布局</h3>
<p>在BIOS的时代，内存布局是非常简单的，前1MB的内存是保留给BIOS的，剩下的内存是可用于OS的。</p>
<p>在UEFI的时代，由于固件提供了多得多的功能，所以内存布局也变得复杂了很多。</p>
<p>在UEFI中，内存布局是由一个叫做<code>EFI_MEMORY_DESCRIPTOR</code>的表来描述的。我们可以使用<code>uefi</code> crate中的<code>SystemTable&lt;Boot&gt;::get_memory_map()</code>来访问这个表：</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">print_memory_info</span><span>(</span><span style="color:#bf616a;">system_table</span><span>: &amp;</span><span style="color:#b48ead;">mut </span><span>SystemTable&lt;Boot&gt;) {
</span><span>    </span><span style="color:#65737e;">// fetch the memory layout
</span><span>    </span><span style="color:#b48ead;">let mut</span><span> buf = [</span><span style="color:#d08770;">0</span><span style="color:#b48ead;">u8</span><span>; </span><span style="color:#d08770;">16_384</span><span>];
</span><span>    </span><span style="color:#b48ead;">let</span><span> buf_ptr = buf.</span><span style="color:#96b5b4;">as_ptr</span><span>() as </span><span style="color:#b48ead;">usize</span><span>;
</span><span>
</span><span>    </span><span style="color:#b48ead;">let</span><span> memory_map = system_table.</span><span style="color:#96b5b4;">boot_services</span><span>().</span><span style="color:#96b5b4;">memory_map</span><span>(&amp;</span><span style="color:#b48ead;">mut</span><span> buf).</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>
</span><span>    </span><span style="color:#65737e;">// print the memory layout
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">Memory map:</span><span>&quot;);
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">{:16} {:16} {:12} </span><span style="color:#d08770;">{:8} {}</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">Physical Addr</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">Virtual Addr</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">Num Pages</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">Size</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">Type</span><span>&quot;);
</span><span>
</span><span>    </span><span style="color:#b48ead;">let mut</span><span> i = </span><span style="color:#d08770;">0</span><span>;
</span><span>    </span><span style="color:#b48ead;">let mut</span><span> total_pages = </span><span style="color:#d08770;">0</span><span>;
</span><span>    </span><span style="color:#b48ead;">let mut</span><span> usable_pages = </span><span style="color:#d08770;">0</span><span>;
</span><span>
</span><span>    </span><span style="color:#b48ead;">for</span><span> descriptor in memory_map.</span><span style="color:#96b5b4;">entries</span><span>() {
</span><span>        total_pages += descriptor.page_count;
</span><span>        </span><span style="color:#b48ead;">if</span><span> descriptor.ty == MemoryType::</span><span style="color:#d08770;">CONVENTIONAL </span><span>{
</span><span>            usable_pages += descriptor.page_count;
</span><span>        }
</span><span>
</span><span>        </span><span style="color:#b48ead;">if</span><span> i != </span><span style="color:#d08770;">0 </span><span>&amp;&amp; (i % </span><span style="color:#d08770;">39</span><span>) == </span><span style="color:#d08770;">0 </span><span>{
</span><span>            println!(&quot;</span><span style="color:#a3be8c;">--- MORE ---</span><span>&quot;);
</span><span>            </span><span style="color:#96b5b4;">wait_for_any_key</span><span>(system_table);
</span><span>        }
</span><span>
</span><span>        print!(
</span><span>            &quot;</span><span style="color:#a3be8c;">{:016X} {:016X} {:12} </span><span>&quot;,
</span><span>            descriptor.phys_start,
</span><span>            descriptor.virt_start,
</span><span>            descriptor.page_count,
</span><span>        );
</span><span>
</span><span>        </span><span style="color:#96b5b4;">print_size_of_pages</span><span>(descriptor.page_count as </span><span style="color:#b48ead;">usize</span><span>);
</span><span>
</span><span>        println!(&quot; </span><span style="color:#d08770;">{:?}</span><span style="color:#a3be8c;"> (</span><span style="color:#d08770;">{:?}</span><span style="color:#a3be8c;">)</span><span>&quot;, descriptor.ty, descriptor.att);
</span><span>
</span><span>        i += </span><span style="color:#d08770;">1</span><span>;
</span><span>    }
</span><span>
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">--- END ---</span><span>&quot;);
</span><span>    print!(&quot;</span><span style="color:#a3be8c;">Total: </span><span>&quot;);
</span><span>    </span><span style="color:#96b5b4;">print_size_of_pages</span><span>(total_pages as </span><span style="color:#b48ead;">usize</span><span>);
</span><span>    print!(&quot;</span><span style="color:#a3be8c;">, Usable: </span><span>&quot;);
</span><span>    </span><span style="color:#96b5b4;">print_size_of_pages</span><span>(usable_pages as </span><span style="color:#b48ead;">usize</span><span>);
</span><span>    println!();
</span><span>    println!();
</span><span>
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">buf (stack) is located at {:016X}, section:</span><span>&quot;, buf_ptr);
</span><span>    </span><span style="color:#96b5b4;">print_pointer_section</span><span>(buf_ptr, &amp;memory_map);
</span><span>
</span><span>    </span><span style="color:#b48ead;">let</span><span> heap_buf = system_table.</span><span style="color:#96b5b4;">boot_services</span><span>().</span><span style="color:#96b5b4;">allocate_pool</span><span>(MemoryType::</span><span style="color:#d08770;">LOADER_DATA</span><span>, </span><span style="color:#d08770;">1024</span><span>).</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>    </span><span style="color:#b48ead;">let</span><span> heap_buf_ptr = heap_buf as </span><span style="color:#b48ead;">usize</span><span>;
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">heap_buf is located at {:016X}, section:</span><span>&quot;, heap_buf_ptr);
</span><span>    </span><span style="color:#96b5b4;">print_pointer_section</span><span>(heap_buf_ptr, &amp;memory_map);
</span><span>    system_table.</span><span style="color:#96b5b4;">boot_services</span><span>().</span><span style="color:#96b5b4;">free_pool</span><span>(heap_buf).</span><span style="color:#96b5b4;">unwrap</span><span>();    
</span><span>}
</span></code></pre>
<p>在上面的代码中，我们首先获取了内存布局，然后打印了内存布局的信息。我们可以看到，内存布局被分成了很多段，我们真正关心的是<code>CONVENTIONAL</code>段，这个段是可用于OS的内存。</p>
<h3 id="jian-ce-tu-xing-xi-tong">检测图形系统</h3>
<p>通常，操作系统的教程主要关注于底层的实现。大多数的这些教程都运行在文本模式下。然而，我对此有着非常不同的喜好。</p>
<p>其原因可以追溯到1995年，我第一次接触到电脑的时候。那是一台运行MS-DOS 6.22的奔腾133MHz的电脑。当时我被QBASIC能够提供的图形体验所惊艳。这是我第一次感受到，我可以通过电脑来释放我的创造力。</p>
<p>BIOS通过<code>int 10h</code>提供了一个非常间的的图形操作接口。大多数的DOS游戏都是通过这个接口来提供沉浸式的游戏体验。</p>
<p>UEFI通过<code>protocol</code>这个概念，提供了一个非常灵活的服务接口。图形输出的接口被称为<code>EFI_GRAPHICS_OUTPUT_PROTOCOL</code>。下面是访问这个接口的代码：</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">print_display_info</span><span>(</span><span style="color:#bf616a;">image_handle</span><span>: Handle, </span><span style="color:#bf616a;">system_table</span><span>: &amp;</span><span style="color:#b48ead;">mut </span><span>SystemTable&lt;Boot&gt;) {
</span><span>    </span><span style="color:#b48ead;">let</span><span> boot_services = system_table.</span><span style="color:#96b5b4;">boot_services</span><span>();
</span><span>    </span><span style="color:#b48ead;">let</span><span> gop_handle = boot_services.get_handle_for_protocol::&lt;GraphicsOutput&gt;().</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>
</span><span>    </span><span style="color:#b48ead;">let</span><span> gop = </span><span style="color:#b48ead;">unsafe </span><span>{ system_table
</span><span>        .</span><span style="color:#96b5b4;">boot_services</span><span>()
</span><span>        .open_protocol::&lt;GraphicsOutput&gt;(OpenProtocolParams {
</span><span>            handle: gop_handle,
</span><span>            agent: image_handle,
</span><span>            controller: None
</span><span>        }, OpenProtocolAttributes::GetProtocol
</span><span>    ) }.</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">Supported Modes:</span><span>&quot;);
</span><span>    </span><span style="color:#b48ead;">for</span><span> mode in gop.</span><span style="color:#96b5b4;">modes</span><span>() {
</span><span>        println!(
</span><span>            &quot;    </span><span style="color:#d08770;">{:4}</span><span style="color:#a3be8c;"> x </span><span style="color:#d08770;">{:4}</span><span style="color:#a3be8c;"> @ </span><span style="color:#d08770;">{:?}</span><span>&quot;,
</span><span>            mode.</span><span style="color:#96b5b4;">info</span><span>().</span><span style="color:#96b5b4;">resolution</span><span>().</span><span style="color:#d08770;">0</span><span>,
</span><span>            mode.</span><span style="color:#96b5b4;">info</span><span>().</span><span style="color:#96b5b4;">resolution</span><span>().</span><span style="color:#d08770;">1</span><span>,
</span><span>            mode.</span><span style="color:#96b5b4;">info</span><span>().</span><span style="color:#96b5b4;">pixel_format</span><span>()
</span><span>        );
</span><span>    };
</span><span>
</span><span>    </span><span style="color:#b48ead;">let</span><span> current_mode = gop.</span><span style="color:#96b5b4;">current_mode_info</span><span>();
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">Current Mode:</span><span>&quot;);
</span><span>    println!(
</span><span>        &quot;    </span><span style="color:#d08770;">{:4}</span><span style="color:#a3be8c;"> x </span><span style="color:#d08770;">{:4}</span><span style="color:#a3be8c;"> @ </span><span style="color:#d08770;">{:?}</span><span>&quot;,
</span><span>        current_mode.</span><span style="color:#96b5b4;">resolution</span><span>().</span><span style="color:#d08770;">0</span><span>,
</span><span>        current_mode.</span><span style="color:#96b5b4;">resolution</span><span>().</span><span style="color:#d08770;">1</span><span>,
</span><span>        current_mode.</span><span style="color:#96b5b4;">pixel_format</span><span>()
</span><span>    );
</span><span>}
</span></code></pre>
<p>在上述的代码中，需要特别解释的是2个API：</p>
<ol>
<li>
<p><code>get_handle_for_protocol</code>: 这个API获得了某种Protocol的Handle。在UEFI中，一个protocol是由一个GUID表示的。图形输出的GUID在<code>uefi</code>这个crate中已经被硬编码在了<code>uefi::proto::console::gop::GraphicsOutput</code>这个结构中。这个handle是我们活得具体的服务所必须的。</p>
</li>
<li>
<p><code>open_protocol</code>: 这个API是我们获得由某个UEFI驱动提供的服务的接口。</p>
</li>
</ol>
<p>通过顺序调用这两个API，我们可以获得图形设备的一些基本功能。</p>
<p>详细的文档可以在<a rel="noopener" target="_blank" href="https://docs.rs/uefi/0.25.0/uefi/proto/console/gop/struct.GraphicsOutput.html"><code>uefi</code>文档</a>中找到。</p>
<p>我们可以使用这些API来改变屏幕的分辨率（<code>set_mode(&amp;mut self, mode: &amp;Mode)</code>），访问帧缓冲区（<code>frame_buffer(&amp;mut self)</code>），以及使用<code>blt</code>来执行屏幕清理和滚动。</p>
<h3 id="jie-xia-lai-zuo-shi-yao">接下来做什么</h3>
<p>在下一篇文章中，我们会尝试切换图形模式，并将日志打印到屏幕上。</p>
<h3 id="yan-shen-yue-du">延伸阅读</h3>
<p>上一篇文章: <a href="/zh/rust-based-os-botting-with-uefi-1/">Get started</a></p>

    </div>

    
    

    <div class="post-footer">
        
            
                <div class="post-tags">
                    
                        <a href="https://cnwzhjs.github.io/tags/uefi/">#uefi</a>
                    
                        <a href="https://cnwzhjs.github.io/tags/efi/">#efi</a>
                    
                        <a href="https://cnwzhjs.github.io/tags/os/">#os</a>
                    
                        <a href="https://cnwzhjs.github.io/tags/rust/">#rust</a>
                    
                </div>
            
            
                <div class="post-nav">
                    
                    
                        <a class="next" href="https:&#x2F;&#x2F;cnwzhjs.github.io&#x2F;zh&#x2F;rust-based-os-botting-with-uefi-1&#x2F;">用Rust写一个支持UEFI的操作系统 (1) ›</a>
                    
                </div>
            

        

    </div>

    
    
</article>


    </div>
  </div>
</body>

</html>
