<!doctype html>

<html lang="zh" class="h-full">

<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-2HTT4P5TRX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-2HTT4P5TRX');
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  
    
  

  
    
      <title>ç”¨Rustå†™ä¸€ä¸ªæ”¯æŒUEFIçš„æ“ä½œç³»ç»Ÿ (2) - Have a bite</title>
    
  

  
  <link rel="alternate" type="application/atom+xml" title="RSS" href="https://cnwzhjs.github.io/atom.xml">
  

  
  <script type="text/javascript" src="/js/menu.js"></script>
  

  
  <link href="/css/site.css" rel="stylesheet">
  

  
  
</head>

<body class="h-full">
  <div class="min-h-full">
    
    <nav class="border-b border-gray-200 bg-white">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="flex h-16 justify-between">
          <div class="flex">
            <div class="flex flex-shrink-0 items-center">
              <span class="border-transparent text-blue-500 inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium">Have a bite</span>
            </div>
            <div class="hidden sm:-my-px sm:ml-6 sm:flex sm:space-x-8">
              
                
              
                
                  
                    
                      <a href="&#x2F;zh&#x2F;" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium">
                        ä¸»é¡µ
                      </a>
                    
                  
                    
                      <a href="&#x2F;zh&#x2F;categories&#x2F;" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium">
                        åˆ†ç±»
                      </a>
                    
                  
                    
                      <a href="&#x2F;zh&#x2F;tags&#x2F;" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium">
                        æ ‡ç­¾
                      </a>
                    
                  
                    
                      <a href="&#x2F;zh&#x2F;about&#x2F;" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium">
                        å…³äº
                      </a>
                    
                  
                
              
            </div>
          </div>
          <div class="hidden sm:ml-6 sm:flex sm:items-center">
            
              <a href="&#x2F;rust-based-os-booting-with-uefi-2&#x2F;" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center border-b-2 px-1 pt-1 text-sm font-medium">ğŸ‡¬ğŸ‡§ EN</a>
            
          </div>
          <div class="-mr-2 flex items-center sm:hidden">
            <!-- Mobile menu button -->
            <button id="menu-btn" type="button" class="relative inline-flex items-center justify-center rounded-md bg-white p-2 text-gray-400 hover:bg-gray-100 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" aria-controls="mobile-menu" aria-expanded="false">
              <span class="absolute -inset-0.5"></span>
              <span class="sr-only">Open main menu</span>
              <!-- Menu open: "hidden", Menu closed: "block" -->
              <svg id="menu-img" class="block h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
              </svg>
              <!-- Menu open: "block", Menu closed: "hidden" -->
              <svg id="close-img" class="hidden h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>
      </div>
  
      <!-- Mobile menu, show/hide based on menu state. -->
      <div class="sm:hidden hidden" id="mobile-menu">
        <div class="space-y-1 pb-3 pt-2">
          
            
          
            
              
                
                  <a href="&#x2F;zh&#x2F;" class="border-transparent text-gray-600 hover:border-gray-300 hover:bg-gray-50 hover:text-gray-800 block border-l-4 py-2 pl-3 pr-4 text-base font-medium">
                    ä¸»é¡µ
                  </a>
                
              
                
                  <a href="&#x2F;zh&#x2F;categories&#x2F;" class="border-transparent text-gray-600 hover:border-gray-300 hover:bg-gray-50 hover:text-gray-800 block border-l-4 py-2 pl-3 pr-4 text-base font-medium">
                    åˆ†ç±»
                  </a>
                
              
                
                  <a href="&#x2F;zh&#x2F;tags&#x2F;" class="border-transparent text-gray-600 hover:border-gray-300 hover:bg-gray-50 hover:text-gray-800 block border-l-4 py-2 pl-3 pr-4 text-base font-medium">
                    æ ‡ç­¾
                  </a>
                
              
                
                  <a href="&#x2F;zh&#x2F;about&#x2F;" class="border-transparent text-gray-600 hover:border-gray-300 hover:bg-gray-50 hover:text-gray-800 block border-l-4 py-2 pl-3 pr-4 text-base font-medium">
                    å…³äº
                  </a>
                
              
            
          
        </div>
        <div class="border-t border-gray-200 pb-3 pt-4">
          <div class="space-y-1">
            
              <a href="&#x2F;rust-based-os-booting-with-uefi-2&#x2F;" class="border-transparent text-gray-600 hover:border-gray-300 hover:bg-gray-50 hover:text-gray-800 block border-l-4 py-2 pl-3 pr-4 text-base font-medium">ğŸ‡¬ğŸ‡§ EN</a>
            
          </div>
        </div>
      </div>
    </nav>
    

    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      


<div class="post-toc hidden" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content always-active">
        <nav id="TableOfContents">
            <ul>
                
                <li>
                    <a href="https://cnwzhjs.github.io/zh/rust-based-os-booting-with-uefi-2/#shi-yao-shi-cao-zuo-xi-tong" class="toc-link">ä»€ä¹ˆæ˜¯æ“ä½œç³»ç»Ÿ</a>
                    
                </li>
                
                <li>
                    <a href="https://cnwzhjs.github.io/zh/rust-based-os-booting-with-uefi-2/#cpuid-zhi-ling" class="toc-link">cpuid æŒ‡ä»¤</a>
                    
                </li>
                
                <li>
                    <a href="https://cnwzhjs.github.io/zh/rust-based-os-booting-with-uefi-2/#jian-ce-nei-cun-bu-ju" class="toc-link">æ£€æµ‹å†…å­˜å¸ƒå±€</a>
                    
                </li>
                
                <li>
                    <a href="https://cnwzhjs.github.io/zh/rust-based-os-booting-with-uefi-2/#jian-ce-tu-xing-xi-tong" class="toc-link">æ£€æµ‹å›¾å½¢ç³»ç»Ÿ</a>
                    
                </li>
                
                <li>
                    <a href="https://cnwzhjs.github.io/zh/rust-based-os-booting-with-uefi-2/#jie-xia-lai-zuo-shi-yao" class="toc-link">æ¥ä¸‹æ¥åšä»€ä¹ˆ</a>
                    
                </li>
                
                <li>
                    <a href="https://cnwzhjs.github.io/zh/rust-based-os-booting-with-uefi-2/#yan-shen-yue-du" class="toc-link">å»¶ä¼¸é˜…è¯»</a>
                    
                </li>
                
            </ul>
        </nav>
    </div>
</div>


<article class="prose">
    
<h2>
    <a href="https:&#x2F;&#x2F;cnwzhjs.github.io&#x2F;zh&#x2F;rust-based-os-booting-with-uefi-2&#x2F;">ç”¨Rustå†™ä¸€ä¸ªæ”¯æŒUEFIçš„æ“ä½œç³»ç»Ÿ (2)</a>
</h2>
<div class="post__meta">
    <span class="post__time">2023-10-24</span>
    
</div>

    <div class="post-content">
      <blockquote>
<p>æ‰€æœ‰çš„ä»£ç éƒ½å¯ä»¥ä»æˆ‘çš„<a rel="noopener" target="_blank" href="https://github.com/cnwzhjs/blog-uefi-os">GitHub repo</a>è·å¾—</p>
</blockquote>
<h3 id="shi-yao-shi-cao-zuo-xi-tong">ä»€ä¹ˆæ˜¯æ“ä½œç³»ç»Ÿ</h3>
<p>åœ¨ç°ä»£è¯­å¢ƒä¸‹ï¼ŒOSè¿™ä¸ªå•è¯å¯èƒ½ä»£è¡¨å¾ˆå¤šä¸œè¥¿ã€‚</p>
<p>OSå¯ä»¥ç”¨æ¥å‘½åä¸€ä¸ªå†…æ ¸ï¼Œä¾‹å¦‚Linuxï¼ŒMachï¼ˆmacOSçš„å†…æ ¸ï¼‰ç­‰ã€‚OSä¹Ÿå¯ä»¥ç”¨æ¥å‘½åä¸€ä¸ªå†…æ ¸å’Œä¸€ç»„ç”¨æˆ·ç©ºé—´ç¨‹åºï¼Œä¾‹å¦‚GNU/Linuxï¼ŒmacOSç­‰ã€‚</p>
<p>åœ¨æœ¬ç³»åˆ—æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨OSå†…æ ¸çš„éƒ¨åˆ†ã€‚é‚£ä¹ˆOSçš„å†…æ ¸ä¸»è¦åšä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>OSå†…æ ¸çš„ä¸»è¦ä½œç”¨æ˜¯æä¾›ç¡¬ä»¶èµ„æºçš„è™šæ‹ŸåŒ–æŠ½è±¡ï¼Œå¹¶ä¸ºç”¨æˆ·ç©ºé—´ç¨‹åºæä¾›ä¸€ç»„APIæ¥ä½¿ç”¨è¿™äº›èµ„æºã€‚</p>
<p>åœ¨è¿™ä¸ªå®šä¹‰ä¸­ï¼ŒOSå†…æ ¸åº”è¯¥ï¼š</p>
<ol>
<li>ç®¡ç†è®¡ç®—ï¼ˆCPUï¼ŒGPUï¼Œåº”ç”¨ç¨‹åºç‰¹å®šåŠ é€Ÿå™¨ï¼‰å’Œå­˜å‚¨èµ„æºï¼ˆå†…å­˜ï¼Œç£ç›˜ç­‰ï¼‰ï¼Œå¹¶å°†å®ƒä»¬åˆ†é…ç»™ç”¨æˆ·ç©ºé—´ç¨‹åºã€‚</li>
<li>æä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£æ¥æ“ä½œå¤–è®¾ï¼ˆé”®ç›˜ï¼Œé¼ æ ‡ï¼Œç½‘ç»œç­‰ï¼‰ã€‚</li>
</ol>
<p>æ‰€ä»¥ï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä¼šå°è¯•é€šè¿‡UEFIæ¥å£æ£€æµ‹è®¾å¤‡çš„æ ¸å¿ƒç¡¬ä»¶èµ„æºï¼š</p>
<ol>
<li>CPU</li>
<li>å†…å­˜å¸ƒå±€</li>
<li>å›¾å½¢</li>
</ol>
<span id="continue-reading"></span><h3 id="cpuid-zhi-ling"><code>cpuid</code> æŒ‡ä»¤</h3>
<p>å¯¹äºæ‰€æœ‰çš„x86 CPUï¼Œéƒ½æœ‰ä¸€ä¸ªç‰¹æ®Šçš„æŒ‡ä»¤å«åš<code>cpuid</code>ã€‚å®ƒç”¨äºæŸ¥è¯¢CPUçš„ç‰¹æ€§ã€‚åœ¨rustä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>raw-cpuid</code> crateæ¥è®¿é—®è¿™ä¸ªæŒ‡ä»¤ã€‚</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">print_cpu_info</span><span>() {
</span><span>    </span><span style="color:#b48ead;">let</span><span> cpuid = CpuId::new();
</span><span>    </span><span style="color:#b48ead;">let</span><span> vendor_info = cpuid.</span><span style="color:#96b5b4;">get_vendor_info</span><span>().</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">Vendor: </span><span style="color:#d08770;">{}</span><span>&quot;, vendor_info.</span><span style="color:#96b5b4;">as_str</span><span>());
</span><span>    </span><span style="color:#b48ead;">let</span><span> brand_info = cpuid.</span><span style="color:#96b5b4;">get_processor_brand_string</span><span>().</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">Processor: </span><span style="color:#d08770;">{}</span><span>&quot;, brand_info.</span><span style="color:#96b5b4;">as_str</span><span>());
</span><span>    </span><span style="color:#b48ead;">let</span><span> feature_info = cpuid.</span><span style="color:#96b5b4;">get_feature_info</span><span>().</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>    </span><span style="color:#b48ead;">let</span><span> extended_processor_feature_info = cpuid.</span><span style="color:#96b5b4;">get_extended_processor_and_feature_identifiers</span><span>().</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>    </span><span style="color:#b48ead;">let</span><span> advanced_pm_info = cpuid.</span><span style="color:#96b5b4;">get_advanced_power_mgmt_info</span><span>().</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">Family: </span><span style="color:#d08770;">{:02X}</span><span style="color:#a3be8c;">h, Model: </span><span style="color:#d08770;">{:02X}</span><span style="color:#a3be8c;">h, Step: </span><span style="color:#d08770;">{:02X}</span><span style="color:#a3be8c;">h</span><span>&quot;, feature_info.</span><span style="color:#96b5b4;">family_id</span><span>(), feature_info.</span><span style="color:#96b5b4;">model_id</span><span>(), feature_info.</span><span style="color:#96b5b4;">stepping_id</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">Max logical processor ids: </span><span style="color:#d08770;">{}</span><span>&quot;, feature_info.</span><span style="color:#96b5b4;">max_logical_processor_ids</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">Features:</span><span>&quot;);
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">    vmx: </span><span style="color:#d08770;">{}</span><span>&quot;, feature_info.</span><span style="color:#96b5b4;">has_vmx</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">    hypervisor: </span><span style="color:#d08770;">{}</span><span>&quot;, feature_info.</span><span style="color:#96b5b4;">has_hypervisor</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">    tsc: </span><span style="color:#d08770;">{}</span><span>&quot;, feature_info.</span><span style="color:#96b5b4;">has_tsc</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">    psn: </span><span style="color:#d08770;">{}</span><span>&quot;, feature_info.</span><span style="color:#96b5b4;">has_psn</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">    sysenter &amp; sysexit: </span><span style="color:#d08770;">{}</span><span>&quot;, feature_info.</span><span style="color:#96b5b4;">has_sysenter_sysexit</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">    syscall &amp; sysret: </span><span style="color:#d08770;">{}</span><span>&quot;, extended_processor_feature_info.</span><span style="color:#96b5b4;">has_syscall_sysret</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">    svm: </span><span style="color:#d08770;">{}</span><span>&quot;, extended_processor_feature_info.</span><span style="color:#96b5b4;">has_svm</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">    de: </span><span style="color:#d08770;">{}</span><span>&quot;, extended_processor_feature_info.</span><span style="color:#96b5b4;">has_execute_disable</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">    1g pages: </span><span style="color:#d08770;">{}</span><span>&quot;, extended_processor_feature_info.</span><span style="color:#96b5b4;">has_1gib_pages</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">    rdtscp: </span><span style="color:#d08770;">{}</span><span>&quot;, extended_processor_feature_info.</span><span style="color:#96b5b4;">has_rdtscp</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">    invariant tsc: </span><span style="color:#d08770;">{}</span><span>&quot;, advanced_pm_info.</span><span style="color:#96b5b4;">has_invariant_tsc</span><span>());
</span><span>}
</span></code></pre>
<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬è·å–äº†CPUçš„åŸºæœ¬ä¿¡æ¯ã€‚æ›´é‡è¦çš„æ˜¯æ£€æµ‹CPUçš„ç‰¹æ€§ã€‚æˆ‘ä»¬çœ‹åˆ°äº†å¾ˆå¤šç¼©å†™ï¼Œè®©æˆ‘ä»¬ä¸€ä¸€è§£é‡Šä¸€ä¸‹æˆ‘ä»¬çš„OSæ‰€éœ€çš„ç‰¹æ€§ï¼š</p>
<ol>
<li><code>tsc</code>: æ—¶é—´æˆ³è®¡æ•°å™¨ï¼ˆæˆ‘ä»¬éœ€è¦æ£€æµ‹CPUæ˜¯å¦æ”¯æŒ <code>rdtsc</code> æŒ‡ä»¤)</li>
<li><code>syscall</code> &amp; <code>sysret</code>: ç³»ç»Ÿè°ƒç”¨å’Œç³»ç»Ÿè¿”å›æŒ‡ä»¤ã€‚ï¼ˆå¦‚æœä½ è¯»è¿‡ä¸€äº›æ¯”è¾ƒè€çš„æ“ä½œç³»ç»Ÿæ•™ç¨‹ï¼Œä»–ä»¬ä¼šä½¿ç”¨<code>int</code>æŒ‡ä»¤æ¥å®ç°ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼Œåœ¨ç°ä»£æ“ä½œç³»ç»Ÿä¸­ï¼Œé€šå¸¸ä½¿ç”¨è¿™ä¸¤ä¸ªæŒ‡ä»¤æ¥å®Œæˆè¿™ä¸ªä»»åŠ¡ï¼Œå®ƒçš„overheadè¦æ›´å°ä¸€äº›ï¼‰</li>
</ol>
<p>å¯¹äºä¸Šè¿°æ£€æµ‹çš„å…¶ä»–ç‰¹æ€§ï¼Œæˆ‘ä»¬ä¼šåœ¨ä»¥åçš„æ–‡ç« ä¸­è§£é‡Šï¼Œåœ¨æœ¬æ–‡ä¸­ä¸å†èµ˜è¿°ã€‚</p>
<h3 id="jian-ce-nei-cun-bu-ju">æ£€æµ‹å†…å­˜å¸ƒå±€</h3>
<p>åœ¨BIOSçš„æ—¶ä»£ï¼Œå†…å­˜å¸ƒå±€æ˜¯éå¸¸ç®€å•çš„ï¼Œå‰1MBçš„å†…å­˜æ˜¯ä¿ç•™ç»™BIOSçš„ï¼Œå‰©ä¸‹çš„å†…å­˜æ˜¯å¯ç”¨äºOSçš„ã€‚</p>
<p>åœ¨UEFIçš„æ—¶ä»£ï¼Œç”±äºå›ºä»¶æä¾›äº†å¤šå¾—å¤šçš„åŠŸèƒ½ï¼Œæ‰€ä»¥å†…å­˜å¸ƒå±€ä¹Ÿå˜å¾—å¤æ‚äº†å¾ˆå¤šã€‚</p>
<p>åœ¨UEFIä¸­ï¼Œå†…å­˜å¸ƒå±€æ˜¯ç”±ä¸€ä¸ªå«åš<code>EFI_MEMORY_DESCRIPTOR</code>çš„è¡¨æ¥æè¿°çš„ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>uefi</code> crateä¸­çš„<code>SystemTable&lt;Boot&gt;::get_memory_map()</code>æ¥è®¿é—®è¿™ä¸ªè¡¨ï¼š</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">print_memory_info</span><span>(</span><span style="color:#bf616a;">system_table</span><span>: &amp;</span><span style="color:#b48ead;">mut </span><span>SystemTable&lt;Boot&gt;) {
</span><span>    </span><span style="color:#65737e;">// fetch the memory layout
</span><span>    </span><span style="color:#b48ead;">let mut</span><span> buf = [</span><span style="color:#d08770;">0</span><span style="color:#b48ead;">u8</span><span>; </span><span style="color:#d08770;">16_384</span><span>];
</span><span>    </span><span style="color:#b48ead;">let</span><span> buf_ptr = buf.</span><span style="color:#96b5b4;">as_ptr</span><span>() as </span><span style="color:#b48ead;">usize</span><span>;
</span><span>
</span><span>    </span><span style="color:#b48ead;">let</span><span> memory_map = system_table.</span><span style="color:#96b5b4;">boot_services</span><span>().</span><span style="color:#96b5b4;">memory_map</span><span>(&amp;</span><span style="color:#b48ead;">mut</span><span> buf).</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>
</span><span>    </span><span style="color:#65737e;">// print the memory layout
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">Memory map:</span><span>&quot;);
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">{:16} {:16} {:12} </span><span style="color:#d08770;">{:8} {}</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">Physical Addr</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">Virtual Addr</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">Num Pages</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">Size</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">Type</span><span>&quot;);
</span><span>
</span><span>    </span><span style="color:#b48ead;">let mut</span><span> i = </span><span style="color:#d08770;">0</span><span>;
</span><span>    </span><span style="color:#b48ead;">let mut</span><span> total_pages = </span><span style="color:#d08770;">0</span><span>;
</span><span>    </span><span style="color:#b48ead;">let mut</span><span> usable_pages = </span><span style="color:#d08770;">0</span><span>;
</span><span>
</span><span>    </span><span style="color:#b48ead;">for</span><span> descriptor in memory_map.</span><span style="color:#96b5b4;">entries</span><span>() {
</span><span>        total_pages += descriptor.page_count;
</span><span>        </span><span style="color:#b48ead;">if</span><span> descriptor.ty == MemoryType::</span><span style="color:#d08770;">CONVENTIONAL </span><span>{
</span><span>            usable_pages += descriptor.page_count;
</span><span>        }
</span><span>
</span><span>        </span><span style="color:#b48ead;">if</span><span> i != </span><span style="color:#d08770;">0 </span><span>&amp;&amp; (i % </span><span style="color:#d08770;">39</span><span>) == </span><span style="color:#d08770;">0 </span><span>{
</span><span>            println!(&quot;</span><span style="color:#a3be8c;">--- MORE ---</span><span>&quot;);
</span><span>            </span><span style="color:#96b5b4;">wait_for_any_key</span><span>(system_table);
</span><span>        }
</span><span>
</span><span>        print!(
</span><span>            &quot;</span><span style="color:#a3be8c;">{:016X} {:016X} {:12} </span><span>&quot;,
</span><span>            descriptor.phys_start,
</span><span>            descriptor.virt_start,
</span><span>            descriptor.page_count,
</span><span>        );
</span><span>
</span><span>        </span><span style="color:#96b5b4;">print_size_of_pages</span><span>(descriptor.page_count as </span><span style="color:#b48ead;">usize</span><span>);
</span><span>
</span><span>        println!(&quot; </span><span style="color:#d08770;">{:?}</span><span style="color:#a3be8c;"> (</span><span style="color:#d08770;">{:?}</span><span style="color:#a3be8c;">)</span><span>&quot;, descriptor.ty, descriptor.att);
</span><span>
</span><span>        i += </span><span style="color:#d08770;">1</span><span>;
</span><span>    }
</span><span>
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">--- END ---</span><span>&quot;);
</span><span>    print!(&quot;</span><span style="color:#a3be8c;">Total: </span><span>&quot;);
</span><span>    </span><span style="color:#96b5b4;">print_size_of_pages</span><span>(total_pages as </span><span style="color:#b48ead;">usize</span><span>);
</span><span>    print!(&quot;</span><span style="color:#a3be8c;">, Usable: </span><span>&quot;);
</span><span>    </span><span style="color:#96b5b4;">print_size_of_pages</span><span>(usable_pages as </span><span style="color:#b48ead;">usize</span><span>);
</span><span>    println!();
</span><span>    println!();
</span><span>
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">buf (stack) is located at {:016X}, section:</span><span>&quot;, buf_ptr);
</span><span>    </span><span style="color:#96b5b4;">print_pointer_section</span><span>(buf_ptr, &amp;memory_map);
</span><span>
</span><span>    </span><span style="color:#b48ead;">let</span><span> heap_buf = system_table.</span><span style="color:#96b5b4;">boot_services</span><span>().</span><span style="color:#96b5b4;">allocate_pool</span><span>(MemoryType::</span><span style="color:#d08770;">LOADER_DATA</span><span>, </span><span style="color:#d08770;">1024</span><span>).</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>    </span><span style="color:#b48ead;">let</span><span> heap_buf_ptr = heap_buf as </span><span style="color:#b48ead;">usize</span><span>;
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">heap_buf is located at {:016X}, section:</span><span>&quot;, heap_buf_ptr);
</span><span>    </span><span style="color:#96b5b4;">print_pointer_section</span><span>(heap_buf_ptr, &amp;memory_map);
</span><span>    system_table.</span><span style="color:#96b5b4;">boot_services</span><span>().</span><span style="color:#96b5b4;">free_pool</span><span>(heap_buf).</span><span style="color:#96b5b4;">unwrap</span><span>();    
</span><span>}
</span></code></pre>
<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆè·å–äº†å†…å­˜å¸ƒå±€ï¼Œç„¶åæ‰“å°äº†å†…å­˜å¸ƒå±€çš„ä¿¡æ¯ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå†…å­˜å¸ƒå±€è¢«åˆ†æˆäº†å¾ˆå¤šæ®µï¼Œæˆ‘ä»¬çœŸæ­£å…³å¿ƒçš„æ˜¯<code>CONVENTIONAL</code>æ®µï¼Œè¿™ä¸ªæ®µæ˜¯å¯ç”¨äºOSçš„å†…å­˜ã€‚</p>
<h3 id="jian-ce-tu-xing-xi-tong">æ£€æµ‹å›¾å½¢ç³»ç»Ÿ</h3>
<p>é€šå¸¸ï¼Œæ“ä½œç³»ç»Ÿçš„æ•™ç¨‹ä¸»è¦å…³æ³¨äºåº•å±‚çš„å®ç°ã€‚å¤§å¤šæ•°çš„è¿™äº›æ•™ç¨‹éƒ½è¿è¡Œåœ¨æ–‡æœ¬æ¨¡å¼ä¸‹ã€‚ç„¶è€Œï¼Œæˆ‘å¯¹æ­¤æœ‰ç€éå¸¸ä¸åŒçš„å–œå¥½ã€‚</p>
<p>å…¶åŸå› å¯ä»¥è¿½æº¯åˆ°1995å¹´ï¼Œæˆ‘ç¬¬ä¸€æ¬¡æ¥è§¦åˆ°ç”µè„‘çš„æ—¶å€™ã€‚é‚£æ˜¯ä¸€å°è¿è¡ŒMS-DOS 6.22çš„å¥”è…¾133MHzçš„ç”µè„‘ã€‚å½“æ—¶æˆ‘è¢«QBASICèƒ½å¤Ÿæä¾›çš„å›¾å½¢ä½“éªŒæ‰€æƒŠè‰³ã€‚è¿™æ˜¯æˆ‘ç¬¬ä¸€æ¬¡æ„Ÿå—åˆ°ï¼Œæˆ‘å¯ä»¥é€šè¿‡ç”µè„‘æ¥é‡Šæ”¾æˆ‘çš„åˆ›é€ åŠ›ã€‚</p>
<p>BIOSé€šè¿‡<code>int 10h</code>æä¾›äº†ä¸€ä¸ªéå¸¸é—´çš„çš„å›¾å½¢æ“ä½œæ¥å£ã€‚å¤§å¤šæ•°çš„DOSæ¸¸æˆéƒ½æ˜¯é€šè¿‡è¿™ä¸ªæ¥å£æ¥æä¾›æ²‰æµ¸å¼çš„æ¸¸æˆä½“éªŒã€‚</p>
<p>UEFIé€šè¿‡<code>protocol</code>è¿™ä¸ªæ¦‚å¿µï¼Œæä¾›äº†ä¸€ä¸ªéå¸¸çµæ´»çš„æœåŠ¡æ¥å£ã€‚å›¾å½¢è¾“å‡ºçš„æ¥å£è¢«ç§°ä¸º<code>EFI_GRAPHICS_OUTPUT_PROTOCOL</code>ã€‚ä¸‹é¢æ˜¯è®¿é—®è¿™ä¸ªæ¥å£çš„ä»£ç ï¼š</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">print_display_info</span><span>(</span><span style="color:#bf616a;">image_handle</span><span>: Handle, </span><span style="color:#bf616a;">system_table</span><span>: &amp;</span><span style="color:#b48ead;">mut </span><span>SystemTable&lt;Boot&gt;) {
</span><span>    </span><span style="color:#b48ead;">let</span><span> boot_services = system_table.</span><span style="color:#96b5b4;">boot_services</span><span>();
</span><span>    </span><span style="color:#b48ead;">let</span><span> gop_handle = boot_services.get_handle_for_protocol::&lt;GraphicsOutput&gt;().</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>
</span><span>    </span><span style="color:#b48ead;">let</span><span> gop = </span><span style="color:#b48ead;">unsafe </span><span>{ system_table
</span><span>        .</span><span style="color:#96b5b4;">boot_services</span><span>()
</span><span>        .open_protocol::&lt;GraphicsOutput&gt;(OpenProtocolParams {
</span><span>            handle: gop_handle,
</span><span>            agent: image_handle,
</span><span>            controller: None
</span><span>        }, OpenProtocolAttributes::GetProtocol
</span><span>    ) }.</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">Supported Modes:</span><span>&quot;);
</span><span>    </span><span style="color:#b48ead;">for</span><span> mode in gop.</span><span style="color:#96b5b4;">modes</span><span>() {
</span><span>        println!(
</span><span>            &quot;    </span><span style="color:#d08770;">{:4}</span><span style="color:#a3be8c;"> x </span><span style="color:#d08770;">{:4}</span><span style="color:#a3be8c;"> @ </span><span style="color:#d08770;">{:?}</span><span>&quot;,
</span><span>            mode.</span><span style="color:#96b5b4;">info</span><span>().</span><span style="color:#96b5b4;">resolution</span><span>().</span><span style="color:#d08770;">0</span><span>,
</span><span>            mode.</span><span style="color:#96b5b4;">info</span><span>().</span><span style="color:#96b5b4;">resolution</span><span>().</span><span style="color:#d08770;">1</span><span>,
</span><span>            mode.</span><span style="color:#96b5b4;">info</span><span>().</span><span style="color:#96b5b4;">pixel_format</span><span>()
</span><span>        );
</span><span>    };
</span><span>
</span><span>    </span><span style="color:#b48ead;">let</span><span> current_mode = gop.</span><span style="color:#96b5b4;">current_mode_info</span><span>();
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">Current Mode:</span><span>&quot;);
</span><span>    println!(
</span><span>        &quot;    </span><span style="color:#d08770;">{:4}</span><span style="color:#a3be8c;"> x </span><span style="color:#d08770;">{:4}</span><span style="color:#a3be8c;"> @ </span><span style="color:#d08770;">{:?}</span><span>&quot;,
</span><span>        current_mode.</span><span style="color:#96b5b4;">resolution</span><span>().</span><span style="color:#d08770;">0</span><span>,
</span><span>        current_mode.</span><span style="color:#96b5b4;">resolution</span><span>().</span><span style="color:#d08770;">1</span><span>,
</span><span>        current_mode.</span><span style="color:#96b5b4;">pixel_format</span><span>()
</span><span>    );
</span><span>}
</span></code></pre>
<p>åœ¨ä¸Šè¿°çš„ä»£ç ä¸­ï¼Œéœ€è¦ç‰¹åˆ«è§£é‡Šçš„æ˜¯2ä¸ªAPIï¼š</p>
<ol>
<li>
<p><code>get_handle_for_protocol</code>: è¿™ä¸ªAPIè·å¾—äº†æŸç§Protocolçš„Handleã€‚åœ¨UEFIä¸­ï¼Œä¸€ä¸ªprotocolæ˜¯ç”±ä¸€ä¸ªGUIDè¡¨ç¤ºçš„ã€‚å›¾å½¢è¾“å‡ºçš„GUIDåœ¨<code>uefi</code>è¿™ä¸ªcrateä¸­å·²ç»è¢«ç¡¬ç¼–ç åœ¨äº†<code>uefi::proto::console::gop::GraphicsOutput</code>è¿™ä¸ªç»“æ„ä¸­ã€‚è¿™ä¸ªhandleæ˜¯æˆ‘ä»¬æ´»å¾—å…·ä½“çš„æœåŠ¡æ‰€å¿…é¡»çš„ã€‚</p>
</li>
<li>
<p><code>open_protocol</code>: è¿™ä¸ªAPIæ˜¯æˆ‘ä»¬è·å¾—ç”±æŸä¸ªUEFIé©±åŠ¨æä¾›çš„æœåŠ¡çš„æ¥å£ã€‚</p>
</li>
</ol>
<p>é€šè¿‡é¡ºåºè°ƒç”¨è¿™ä¸¤ä¸ªAPIï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—å›¾å½¢è®¾å¤‡çš„ä¸€äº›åŸºæœ¬åŠŸèƒ½ã€‚</p>
<p>è¯¦ç»†çš„æ–‡æ¡£å¯ä»¥åœ¨<a rel="noopener" target="_blank" href="https://docs.rs/uefi/0.25.0/uefi/proto/console/gop/struct.GraphicsOutput.html"><code>uefi</code>æ–‡æ¡£</a>ä¸­æ‰¾åˆ°ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™äº›APIæ¥æ”¹å˜å±å¹•çš„åˆ†è¾¨ç‡ï¼ˆ<code>set_mode(&amp;mut self, mode: &amp;Mode)</code>ï¼‰ï¼Œè®¿é—®å¸§ç¼“å†²åŒºï¼ˆ<code>frame_buffer(&amp;mut self)</code>ï¼‰ï¼Œä»¥åŠä½¿ç”¨<code>blt</code>æ¥æ‰§è¡Œå±å¹•æ¸…ç†å’Œæ»šåŠ¨ã€‚</p>
<h3 id="jie-xia-lai-zuo-shi-yao">æ¥ä¸‹æ¥åšä»€ä¹ˆ</h3>
<p>åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä¼šå°è¯•åˆ‡æ¢å›¾å½¢æ¨¡å¼ï¼Œå¹¶å°†æ—¥å¿—æ‰“å°åˆ°å±å¹•ä¸Šã€‚</p>
<h3 id="yan-shen-yue-du">å»¶ä¼¸é˜…è¯»</h3>
<p>ä¸Šä¸€ç¯‡æ–‡ç« : <a href="/zh/rust-based-os-botting-with-uefi-1/">Get started</a></p>

    </div>

    
    

    <div class="post-footer">
        
            
                <div class="post-tags">
                    
                        <a href="https://cnwzhjs.github.io/tags/uefi/">#uefi</a>
                    
                        <a href="https://cnwzhjs.github.io/tags/efi/">#efi</a>
                    
                        <a href="https://cnwzhjs.github.io/tags/os/">#os</a>
                    
                        <a href="https://cnwzhjs.github.io/tags/rust/">#rust</a>
                    
                </div>
            
            
                <div class="post-nav">
                    
                    
                        <a class="next" href="https:&#x2F;&#x2F;cnwzhjs.github.io&#x2F;zh&#x2F;rust-based-os-botting-with-uefi-1&#x2F;">ç”¨Rustå†™ä¸€ä¸ªæ”¯æŒUEFIçš„æ“ä½œç³»ç»Ÿ (1) â€º</a>
                    
                </div>
            

        

    </div>

    
    
</article>


    </div>
  </div>
</body>

</html>
